<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.85.0" /><link rel="alternate" type="application/rss&#43;xml" href="/preview/getting-started-with-terraform/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
<head>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="alternate icon" href="/favicon.ico">
</head>

<title>Getting Started with Terraform | Karpenter</title>
<meta name="description" content="Just-in-time Nodes for Any Kubernetes Cluster"><meta property="og:title" content="Getting Started with Terraform" />
<meta property="og:description" content="Just-in-time Nodes for Any Kubernetes Cluster" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/preview/getting-started-with-terraform/" /><meta property="og:image" content="/banner.png"/><meta property="og:site_name" content="Karpenter" />

<meta itemprop="name" content="Getting Started with Terraform">
<meta itemprop="description" content="Just-in-time Nodes for Any Kubernetes Cluster"><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/banner.png"/>

<meta name="twitter:title" content="Getting Started with Terraform"/>
<meta name="twitter:description" content="Just-in-time Nodes for Any Kubernetes Cluster"/>




<link rel="preload" href="/scss/main.min.0b37f95108ce37f0b7d48c3e28f4085b93466316038fb0f812edd03ec2597fa9.css" as="style">
<link href="/scss/main.min.0b37f95108ce37f0b7d48c3e28f4085b93466316038fb0f812edd03ec2597fa9.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>





  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand-md navbar-dark  td-navbar py-2">
	<a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg viewBox="0 0 500 443" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M237.704918.0C314.662629.0 377.04918 62.3865513 377.04918 139.344262L377.049 336.352 442.622951 336.351852C474.31142 336.351852 5e2 362.040432 5e2 393.728901V443h-7.546066c-18.225271.0-33.094961-14.592764-33.437541-32.814815V401.960534L459.013099 401.553891C458.795948 388.160675 447.871194 377.37037 434.42623 377.37037H106.557377c-58.8500143.0-106.557377-47.707362-106.557377-106.557377L-100611761e-22 139.344262c0-76.9577107 62.3865513-139.344262 139.344262-139.344262zm-8.196721 41.0185185H147.540984L145.778863 41.0327942C87.7415928 41.97378 40.9836066 89.3143814 40.9836066 147.575896V270.778081L40.9923916 271.862464C41.5714598 307.577706 70.7041376 336.351852 106.557377 336.351852H270.491803c36.215394.0 65.573771-29.358377 65.573771-65.573771V147.575896L336.051298 145.813774C335.110312 87.7765047 287.769711 41.0185185 229.508197 41.0185185zM147.868852 106.648148C157.213115 106.648148 164.590164 114.277593 164.590164 123.875926v49.960555l56.803279-58.574444C228.770492 108.370926 238.852459 107.878704 245.983607 114.523704V114.769815C252.868852 121.168704 252.377049 131.751481 244.754098 138.642593l-42.04918 43.315555 48.934426 69.895556C257.540984 260.467593 255.819672 271.296481 247.95082 276.464815 239.344262 281.387037 229.508197 278.679815 223.606557 270.065926l-44.016393-64.481111-15 15.751111v40.362222c0 9.84444500000001-7.377049 17.227778-16.721312 17.227778C138.52459 278.925926 131.147541 271.542593 131.147541 261.698148V123.875926c0-9.59833300000001 7.377049-17.227778 16.721311-17.227778z" id="white_square_logo" fill="#fff"/></g></svg></span><span class="text-uppercase font-weight-bold">Karpenter</span>
	</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_navbar" aria-controls="main_navbar" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse ml-md-auto" id="main_navbar">
		<ul class="navbar-nav ml-auto pt-4 pt-md-0 my-2 my-md-1">
			
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/preview/getting-started/" ><span>Getting Started</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/preview/" ><i class='fas fa-book'></i><span class="active">Docs</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/aws/karpenter" target="_blank" ><i class='fab fa-github'></i><span>GitHub</span></a>
			</li>
			
			
      		<li class="nav-item dropdown mt-1 mt-lg-0 mr-2">
        		




	

	

	

	

	

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	preview
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="navbarVersionSelector">
	
	<a class="dropdown-item" href="/docs/">v0.5.4</a>
	
	<a class="dropdown-item" href="/v0.5.3-docs/">v0.5.3</a>
	
	<a class="dropdown-item" href="/v0.5.2-docs/">v0.5.2</a>
	
	<a class="dropdown-item" href="/v0.5.0-docs/">v0.5.0</a>
	
	<a class="dropdown-item" href="/v0.4.3-docs/">v0.4.3</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.d016e33954ed0639efa943586ae122a3.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>
    </header>
    <div class="container-fluid td-default td-outer">
      <main role="main" class="td-main">
        

<p>Karpenter automatically provisions new nodes in response to unschedulable
pods. Karpenter does this by observing events within the Kubernetes cluster,
and then sending commands to the underlying cloud provider.</p>
<p>In this example, the cluster is running on Amazon Web Services (AWS) Elastic
Kubernetes Service (EKS). Karpenter is designed to be cloud provider agnostic,
but currently only supports AWS. Contributions are welcomed.</p>
<p>This guide should take less than 1 hour to complete, and cost less than $0.25.
Follow the clean-up instructions to reduce any charges.</p>
<h2 id="install">Install</h2>
<p>Karpenter is installed in clusters with a helm chart.</p>
<p>Karpenter additionally requires IAM Roles for Service Accounts (IRSA). IRSA
permits Karpenter (within the cluster) to make privileged requests to AWS (as
the cloud provider).</p>
<h3 id="required-utilities">Required Utilities</h3>
<p>Install these tools before proceeding:</p>
<ol>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html">AWS CLI</a></li>
<li><code>kubectl</code> - <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">the Kubernetes CLI</a></li>
<li><code>terraform</code> - <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">infrastructure-as-code tool made by HashiCorp</a></li>
<li><code>helm</code> - <a href="https://helm.sh/docs/intro/install/">the package manager for Kubernetes</a></li>
</ol>
<p>Login to the AWS CLI with a user that has sufficient privileges to create a
cluster.</p>
<h3 id="setting-up-variables">Setting up Variables</h3>
<p>After setting up the tools, set the following environment variables to store
commonly used values.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#204a87">export</span> <span style="color:#000">CLUSTER_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$USER</span>-karpenter-demo
<span style="color:#204a87">export</span> <span style="color:#000">AWS_DEFAULT_REGION</span><span style="color:#ce5c00;font-weight:bold">=</span>us-west-2
</code></pre></div><p>The first thing we need to do is create our <code>main.tf</code> file and place the
following in it. This will let us pass in a cluster name that will be used
throughout the remainder of our config.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#204a87;font-weight:bold">variable</span> <span style="color:#4e9a06">&#34;cluster_name&#34;</span> {
<span style="color:#000">  description</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;The name of the cluster&#34;</span>
<span style="color:#000">  type</span>        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">string</span>
}
</code></pre></div><h3 id="create-a-cluster">Create a Cluster</h3>
<p>We&rsquo;re going to use two different Terraform modules to create our cluster - one
to create the VPC and another for the cluster itself. The key part of this is
that we need to tag the VPC subnets that we want to use for the worker nodes.</p>
<p>Place the following Terraform config into your <code>main.tf</code> file.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#4e9a06">&#34;vpc&#34;</span> {
<span style="color:#000">  source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;terraform-aws-modules/vpc/aws&#34;</span>

<span style="color:#000">  name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">var</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster_name</span>
<span style="color:#000">  cidr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;10.0.0.0/16&#34;</span>

<span style="color:#000">  azs</span>             <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;us-east-1a&#34;, &#34;us-east-1b&#34;, &#34;us-east-1c&#34;</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#000">  private_subnets</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;10.0.1.0/24&#34;, &#34;10.0.2.0/24&#34;, &#34;10.0.3.0/24&#34;</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#000">  public_subnets</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;10.0.101.0/24&#34;, &#34;10.0.102.0/24&#34;, &#34;10.0.103.0/24&#34;</span><span style="color:#000;font-weight:bold">]</span>

<span style="color:#000">  enable_nat_gateway</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
<span style="color:#000">  single_nat_gateway</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
<span style="color:#000">  one_nat_gateway_per_az</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>

<span style="color:#000">  private_subnet_tags</span> <span style="color:#ce5c00;font-weight:bold">=</span> {
<span style="color:#000">    &#34;kubernetes.io/cluster/${var.cluster_name}&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;owned&#34;</span>
  }
}

<span style="color:#204a87;font-weight:bold">module</span> <span style="color:#4e9a06">&#34;eks&#34;</span> {
<span style="color:#000">  source</span>          <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;terraform-aws-modules/eks/aws&#34;</span>
<span style="color:#000">  version</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&lt;18&#34;</span>

<span style="color:#000">  cluster_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.21&#34;</span>
<span style="color:#000">  cluster_name</span>    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">var</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster_name</span>
<span style="color:#000">  vpc_id</span>          <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">vpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">vpc_id</span>
<span style="color:#000">  subnets</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">vpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">private_subnets</span>
<span style="color:#000">  enable_irsa</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">  # Only need one node to get Karpenter up and running
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">  worker_groups</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
    {
<span style="color:#000">      instance_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;t3a.medium&#34;</span>
<span style="color:#000">      asg_max_size</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
    }
  <span style="color:#000;font-weight:bold">]</span>
}
</code></pre></div><p>At this point, go ahead and apply what we&rsquo;ve done to create the VPC and
cluster. This may take some time.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">terraform init
terraform apply -var <span style="color:#000">cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$CLUSTER_NAME</span>
</code></pre></div><p>There&rsquo;s a good chance it will fail when trying to configure the aws-auth
ConfigMap. And that&rsquo;s because we need to use the kubeconfig file that was
generated during the cluster install. To use it, run the following. This will
configure both your local CLI and Terraform to use the file. Then try the apply
again.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#204a87">export</span> <span style="color:#000">KUBECONFIG</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PWD</span><span style="color:#4e9a06">}</span>/kubeconfig_<span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span>
<span style="color:#204a87">export</span> <span style="color:#000">KUBE_CONFIG_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$KUBECONFIG</span>
terraform apply -var <span style="color:#000">cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$CLUSTER_NAME</span>
</code></pre></div><p>Everything should apply successfully now!</p>
<h3 id="configure-the-karpenternode-iam-role">Configure the KarpenterNode IAM Role</h3>
<p>The EKS module creates an IAM role for worker nodes. We&rsquo;ll use that for
Karpenter (so we don&rsquo;t have to reconfigure the aws-auth ConfigMap), but we need
to add one more policy and create an instance profile.</p>
<p>Place the following into your <code>main.tf</code> to add the policy and create an
instance profile.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#204a87;font-weight:bold">data</span> <span style="color:#4e9a06">&#34;aws_iam_policy&#34; &#34;ssm_managed_instance&#34;</span> {
<span style="color:#000">  arn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&#34;</span>
}

<span style="color:#204a87;font-weight:bold">resource</span> <span style="color:#4e9a06">&#34;aws_iam_role_policy_attachment&#34; &#34;karpenter_ssm_policy&#34;</span> {
<span style="color:#000">  role</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">eks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">worker_iam_role_name</span>
<span style="color:#000">  policy_arn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">aws_iam_policy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">ssm_managed_instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">arn</span>
}

<span style="color:#204a87;font-weight:bold">resource</span> <span style="color:#4e9a06">&#34;aws_iam_instance_profile&#34; &#34;karpenter&#34;</span> {
<span style="color:#000">  name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;KarpenterNodeInstanceProfile-${var.cluster_name}&#34;</span>
<span style="color:#000">  role</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">eks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">worker_iam_role_name</span>
}
</code></pre></div><p>Go ahead and apply the changes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">terraform apply -var <span style="color:#000">cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$CLUSTER_NAME</span>
</code></pre></div><p>Now, Karpenter can use this instance profile to launch new EC2 instances and
those instances will be able to connect to your cluster.</p>
<h3 id="create-the-karpentercontroller-iam-role">Create the KarpenterController IAM Role</h3>
<p>Karpenter requires permissions like launching instances, which means it needs
an IAM role that grants it access. The config below will create an AWS IAM
Role, attach a policy, and authorize the Service Account to assume the role
using <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html">IRSA</a>.
We will create the ServiceAccount and connect it to this role during the Helm
chart install.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#4e9a06">&#34;iam_assumable_role_karpenter&#34;</span> {
<span style="color:#000">  source</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;terraform-aws-modules/iam/aws//modules/iam-assumable-role-with-oidc&#34;</span>
<span style="color:#000">  version</span>                       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;4.7.0&#34;</span>
<span style="color:#000">  create_role</span>                   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
<span style="color:#000">  role_name</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;karpenter-controller-${var.cluster_name}&#34;</span>
<span style="color:#000">  provider_url</span>                  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">eks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster_oidc_issuer_url</span>
<span style="color:#000">  oidc_fully_qualified_subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;system:serviceaccount:karpenter:karpenter&#34;</span><span style="color:#000;font-weight:bold">]</span>
}

<span style="color:#204a87;font-weight:bold">resource</span> <span style="color:#4e9a06">&#34;aws_iam_role_policy&#34; &#34;karpenter_controller&#34;</span> {
<span style="color:#000">  name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;karpenter-policy-${var.cluster_name}&#34;</span>
<span style="color:#000">  role</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">iam_assumable_role_karpenter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">iam_role_name</span>

<span style="color:#000">  policy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">jsonencode</span><span style="color:#000;font-weight:bold">(</span>{
<span style="color:#000">    Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;2012-10-17&#34;</span>
<span style="color:#000">    Statement</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
      {
<span style="color:#000">        Action</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
          <span style="color:#4e9a06">&#34;ec2:CreateLaunchTemplate&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:CreateFleet&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:RunInstances&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:CreateTags&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;iam:PassRole&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:TerminateInstances&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeLaunchTemplates&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeInstances&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeSecurityGroups&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeSubnets&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeInstanceTypes&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeInstanceTypeOfferings&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ec2:DescribeAvailabilityZones&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#4e9a06">&#34;ssm:GetParameter&#34;</span>
        <span style="color:#000;font-weight:bold">]</span>
<span style="color:#000">        Effect</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Allow&#34;</span>
<span style="color:#000">        Resource</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;*&#34;</span>
      }<span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">]</span>
  }<span style="color:#000;font-weight:bold">)</span>
}
</code></pre></div><p>Since we&rsquo;ve added a new module, you&rsquo;ll need to run <code>terraform init</code> again.
Then, apply the changes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">terraform init
terraform apply -var <span style="color:#000">cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$CLUSTER_NAME</span>
</code></pre></div><h3 id="install-karpenter-helm-chart">Install Karpenter Helm Chart</h3>
<p>Use helm to deploy Karpenter to the cluster. We are going to use the
<code>helm_release</code> Terraform resource to do the deploy and pass in the cluster
details and IAM role Karpenter needs to assume.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#204a87;font-weight:bold">resource</span> <span style="color:#4e9a06">&#34;helm_release&#34; &#34;karpenter&#34;</span> {
<span style="color:#000">  depends_on</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">eks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">kubeconfig</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#000">  namespace</span>        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;karpenter&#34;</span>
<span style="color:#000">  create_namespace</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>

<span style="color:#000">  name</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;karpenter&#34;</span>
<span style="color:#000">  repository</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;https://charts.karpenter.sh&#34;</span>
<span style="color:#000">  chart</span>      <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;karpenter&#34;</span>
<span style="color:#000">  version</span>    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.5.4&#34;</span>

  <span style="color:#204a87;font-weight:bold">set</span> {
<span style="color:#000">    name</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn&#34;</span>
<span style="color:#000">    value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">iam_assumable_role_karpenter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">iam_role_arn</span>
  }

  <span style="color:#204a87;font-weight:bold">set</span> {
<span style="color:#000">    name</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;controller.clusterName&#34;</span>
<span style="color:#000">    value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">var</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster_name</span>
  }

  <span style="color:#204a87;font-weight:bold">set</span> {
<span style="color:#000">    name</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;controller.clusterEndpoint&#34;</span>
<span style="color:#000">    value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">eks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cluster_endpoint</span>
  }
}
</code></pre></div><p>Now, deploy Karpenter by applying the new Terraform config.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">terraform init
terraform apply -var <span style="color:#000">cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$CLUSTER_NAME</span>
</code></pre></div><h3 id="enable-debug-logging-optional">Enable Debug Logging (optional)</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">kubectl patch configmap config-logging -n karpenter --patch <span style="color:#4e9a06">&#39;{&#34;data&#34;:{&#34;loglevel.controller&#34;:&#34;debug&#34;}}&#39;</span>
</code></pre></div><h3 id="provisioner">Provisioner</h3>
<p>A single Karpenter provisioner is capable of handling many different pod
shapes. Karpenter makes scheduling and provisioning decisions based on pod
attributes such as labels and affinity. In other words, Karpenter eliminates
the need to manage many different node groups.</p>
<p>Create a default provisioner using the command below. This provisioner
configures instances to connect to your cluster&rsquo;s endpoint and discovers
resources like subnets and security groups using the cluster&rsquo;s name.</p>
<p>The <code>ttlSecondsAfterEmpty</code> value configures Karpenter to terminate empty nodes.
This behavior can be disabled by leaving the value undefined.</p>
<p>Review the <a href="/docs/provisioner-crd">provisioner CRD</a> for more information. For example,
<code>ttlSecondsUntilExpired</code> configures Karpenter to terminate nodes when a maximum age is reached.</p>
<p>Note: This provisioner will create capacity as long as the sum of all created capacity is less than the specified limit.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#4e9a06">&lt;&lt;EOF | kubectl apply -f -
</span><span style="color:#4e9a06">apiVersion: karpenter.sh/v1alpha5
</span><span style="color:#4e9a06">kind: Provisioner
</span><span style="color:#4e9a06">metadata:
</span><span style="color:#4e9a06">  name: default
</span><span style="color:#4e9a06">spec:
</span><span style="color:#4e9a06">  requirements:
</span><span style="color:#4e9a06">    - key: karpenter.sh/capacity-type
</span><span style="color:#4e9a06">      operator: In
</span><span style="color:#4e9a06">      values: [&#34;spot&#34;]
</span><span style="color:#4e9a06">  limits:
</span><span style="color:#4e9a06">    resources:
</span><span style="color:#4e9a06">      cpu: 1000
</span><span style="color:#4e9a06">  provider:
</span><span style="color:#4e9a06">    instanceProfile: KarpenterNodeInstanceProfile-${CLUSTER_NAME}
</span><span style="color:#4e9a06">  ttlSecondsAfterEmpty: 30
</span><span style="color:#4e9a06">EOF</span>
</code></pre></div><h2 id="first-use">First Use</h2>
<p>Karpenter is now active and ready to begin provisioning nodes.
Create some pods using a deployment, and watch Karpenter provision nodes in response.</p>
<h3 id="automatic-node-provisioning">Automatic Node Provisioning</h3>
<p>This deployment uses the <a href="https://www.ianlewis.org/en/almighty-pause-container">pause image</a> and starts with zero replicas.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#4e9a06">&lt;&lt;EOF | kubectl apply -f -
</span><span style="color:#4e9a06">apiVersion: apps/v1
</span><span style="color:#4e9a06">kind: Deployment
</span><span style="color:#4e9a06">metadata:
</span><span style="color:#4e9a06">  name: inflate
</span><span style="color:#4e9a06">spec:
</span><span style="color:#4e9a06">  replicas: 0
</span><span style="color:#4e9a06">  selector:
</span><span style="color:#4e9a06">    matchLabels:
</span><span style="color:#4e9a06">      app: inflate
</span><span style="color:#4e9a06">  template:
</span><span style="color:#4e9a06">    metadata:
</span><span style="color:#4e9a06">      labels:
</span><span style="color:#4e9a06">        app: inflate
</span><span style="color:#4e9a06">    spec:
</span><span style="color:#4e9a06">      terminationGracePeriodSeconds: 0
</span><span style="color:#4e9a06">      containers:
</span><span style="color:#4e9a06">        - name: inflate
</span><span style="color:#4e9a06">          image: public.ecr.aws/eks-distro/kubernetes/pause:3.2
</span><span style="color:#4e9a06">          resources:
</span><span style="color:#4e9a06">            requests:
</span><span style="color:#4e9a06">              cpu: 1
</span><span style="color:#4e9a06">EOF</span>
kubectl scale deployment inflate --replicas <span style="color:#0000cf;font-weight:bold">5</span>
kubectl logs -f -n karpenter <span style="color:#204a87;font-weight:bold">$(</span>kubectl get pods -n karpenter -l <span style="color:#000">karpenter</span><span style="color:#ce5c00;font-weight:bold">=</span>controller -o name<span style="color:#204a87;font-weight:bold">)</span>
</code></pre></div><h3 id="automatic-node-termination">Automatic Node Termination</h3>
<p>Now, delete the deployment. After 30 seconds (<code>ttlSecondsAfterEmpty</code>),
Karpenter should terminate the now empty nodes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete deployment inflate
kubectl logs -f -n karpenter <span style="color:#204a87;font-weight:bold">$(</span>kubectl get pods -n karpenter -l <span style="color:#000">karpenter</span><span style="color:#ce5c00;font-weight:bold">=</span>controller -o name<span style="color:#204a87;font-weight:bold">)</span>
</code></pre></div><h3 id="manual-node-termination">Manual Node Termination</h3>
<p>If you delete a node with kubectl, Karpenter will gracefully cordon, drain,
and shutdown the corresponding instance. Under the hood, Karpenter adds a
finalizer to the node object, which blocks deletion until all pods are
drained and the instance is terminated. Keep in mind, this only works for
nodes provisioned by Karpenter.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete node <span style="color:#000">$NODE_NAME</span>
</code></pre></div><h2 id="cleanup">Cleanup</h2>
<p>To avoid additional charges, remove the demo infrastructure from your AWS
account. Since Karpenter is managing nodes outside of Terraform&rsquo;s view, we need
to remove the pods and node first (if you haven&rsquo;t already). Once the node is
removed, you can remove the rest of the infrastructure.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete deployment inflate
kubectl delete node -l karpenter.sh/provisioner-name<span style="color:#ce5c00;font-weight:bold">=</span>default
terraform destroy -var <span style="color:#000">cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$CLUSTER_NAME</span>
</code></pre></div>


      </main>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <p class="mx-auto col-sm-3 text-center text-light">
        Built with ❤️ at <a class="text-light" href="https://aws.amazon.com/">AWS</a>
      </p>
    </div>
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
          
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
          
            
  <ul class="list-inline mb-0">
    
      <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
        <a class="text-white" target="_blank" rel="noopener" href="https://github.com/aws/karpenter" aria-label="GitHub">
          <i class="fab fa-github"></i>
        </a>
      </li>
    
      <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
        <a class="text-white" target="_blank" rel="noopener" href="https://slack.k8s.io/" aria-label="Slack">
          <i class="fab fa-slack"></i>
        </a>
      </li>
    
  </ul>

          
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 Amazon.com, Inc. or its affiliates. All Rights Reserved</small>
        
        
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 













<script src="/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js" integrity="sha256-OxcsE7YsK&#43;qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin="anonymous"></script>


<script>

    
    function WarningElement(version) {
        let RawElement = `
        <div class="alert alert-warning" role="alert">
            <h3>
                You are viewing documentation for Karpenter version: ${version}
            </h3>
            <p> Karpenter ${version} documentation is not the latest stable release. The version you are currently viewing is a static snapshot. For up-to-date documentation, see the 
                <a href="/docs/">latest version.</a>
            </p>
        </div>
        `
        let TemplateElement = document.createElement('div')
        TemplateElement.innerHTML = RawElement

        return TemplateElement
    }

    //create the html element with the version string
    function PrereleaseElement() {
        let RawElement = `
        <div class="alert alert-warning" role="alert">
            <h3>
                You are viewing pre-release documentation for Karpenter 
            </h3>
            <p> Karpenter pre-release documentation is under active development. The documentation, and included APIs, are unstable. For up-to-date documentation, see the 
                <a href="/docs/">latest version.</a>
            </p>
        </div>
        `
        let TemplateElement = document.createElement('div')
        TemplateElement.innerHTML = RawElement

        return TemplateElement
    }
    
    //determine if path is /v1-docs/ (archived) or /docs/ (latest)
    let re = new RegExp ('/(.*)\-docs')
    const result = window.location.pathname.match(re)
    const ArchiveStatus = result.length > 0

    if (ArchiveStatus) {
        //get version string from match result
        let Version = result[1]

        const target = document.querySelector(".td-content > h1")

        if (Version == "pre"){
            target.parentNode.insertBefore(PrereleaseElement(), target)
        }
        else {
            target.parentNode.insertBefore(WarningElement(Version), target)
        }
        
    }
</script>


  </body>
</html>