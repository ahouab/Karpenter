apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: suite
  namespace: karpenter-tests
spec:
  params:
    - name: cluster-name
      default: $(context.pipelineRun.namespace)-$(context.pipelineRun.name)
      description: Uniquely identifies a cluster name for the suite.
    - name: git-ref
      default: HEAD
      description: Git commit, tag, or branch to check out. Requires a corresponding Karpenter snapshot release.
    - name: suite-path
      description: Path to the test suite from the git-ref root directory. (e.g. ./test/suites/...)
    - name: cleanup
      default: "true"
      description: If true, clean up resources
  tasks:

  - name: setup
    taskRef:
      name: setup
    params:
    - name: cluster-name
      value: $(params.cluster-name)
    - name: git-ref
      value: $(params.git-ref)

  - name: run-test
    taskRef:
      name: run-test
    params:
    - name: cluster-name
      value: $(params.cluster-name)
    - name: git-ref
      value: $(params.git-ref)
    - name: suite-path
      value: $(params.suite-path)
    runAfter:
    - setup

  finally:
  - name: cleanup
    taskRef:
      name: cleanup
    params:
    - name: cluster-name
      value: $(params.cluster-name)
    when:
    - input: $(params.cleanup)
      operator: in
      values:
        - "true"
