apiVersion: v1
kind: ConfigMap
metadata:
  name: sweeper
  namespace: karpenter-tests
data:
  sweeper.sh: |+
    #!/usr/bin/env bash
    set -euo pipefail
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sweeper
  namespace: karpenter-tests
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: scripts
              configMap:
                name: scripts
                defaultMode: 0777
          containers:
            - command:
                - /bin/sh
                - -c
                - /bin/sweeper.sh
              image: public.ecr.aws/bitnami/kubectl:1.22
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: scripts
                  mountPath: /bin/sweeper.sh
                  subPath: sweeper.sh
              name: sweeper
              resources:
                requests:
                  cpu: 250m
                  memory: 256Mi
                limits:
                  memory: 256Mi
          restartPolicy: OnFailure
          # This serviceAccountName has permission to make calls against EC2 in the account
          serviceAccountName: karpenter-tests
      ttlSecondsAfterFinished: 300
  # every day on the 12th hour
  schedule: '* 12 * * *'
  successfulJobsHistoryLimit: 3
  suspend: false
